<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gender War Game</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Special+Elite&family=Crimson+Pro:wght@400;600&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html, body { height: 100%; overflow: hidden; }
body {
    font-family: 'Crimson Pro', Georgia, serif;
    background: #1a1216;
    color: #fff8f0;
    line-height: 1.6;
}

/* SCREEN ROUTING */
.screen {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    overflow-y: auto;
}
.screen.active {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}
.hidden { display: none !important; }

/* Buttons */
button {
    font-family: 'Special Elite', monospace;
    padding: 1rem 2rem;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 1rem;
    text-transform: uppercase;
    letter-spacing: 2px;
    transition: all 150ms ease;
}
.btn-primary {
    background: linear-gradient(135deg, #ff4d6d, #ff6b8a);
    color: white;
    box-shadow: 0 4px 15px rgba(255, 77, 109, 0.4);
}
.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(255, 77, 109, 0.6);
}
.btn-secondary {
    background: transparent;
    color: #b8a9a0;
    border: 1px solid #6b5a52;
}
.btn-secondary:hover {
    border-color: #fff8f0;
    color: #fff8f0;
}
.btn-modal {
    width: 100%;
    background: #2a1f24;
    color: #fff8f0;
    border: 1px solid #6b5a52;
    margin-bottom: 0.5rem;
}
.btn-modal:hover {
    background: #ff4d6d;
    border-color: #ff4d6d;
}
@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}
.pulse { animation: pulse 2s infinite; }

/* Title Screen */
#screen-title {
    background: 
        radial-gradient(ellipse at 30% 20%, rgba(255, 77, 109, 0.15) 0%, transparent 50%),
        radial-gradient(ellipse at 70% 80%, rgba(78, 205, 196, 0.1) 0%, transparent 50%),
        #1a1216;
}
.title-container { text-align: center; padding: 2rem; }
.title-decoration {
    width: 200px;
    height: 2px;
    margin: 1.5rem auto;
    background: linear-gradient(90deg, transparent, #ff4d6d, transparent);
}
.game-title {
    font-family: 'Special Elite', monospace;
    font-size: clamp(3rem, 10vw, 6rem);
    letter-spacing: 8px;
    color: #fff8f0;
    text-shadow: 0 0 40px rgba(255, 77, 109, 0.5), 0 0 80px rgba(255, 77, 109, 0.3);
    margin-bottom: 0.5rem;
}
.game-subtitle {
    font-size: 1.2rem;
    color: #b8a9a0;
    font-style: italic;
    margin-bottom: 2rem;
}
.title-warning {
    margin-top: 2rem;
    font-size: 0.85rem;
    color: #6b5a52;
}

/* Creator Screen */
#screen-creator {
    background: #1a1216;
    padding: 1.5rem;
}
.creator-container { width: 100%; max-width: 900px; }
.screen-title {
    font-family: 'Special Elite', monospace;
    font-size: 1.8rem;
    text-align: center;
    margin-bottom: 2rem;
    letter-spacing: 4px;
}
.creator-layout {
    display: grid;
    grid-template-columns: 1fr 1.5fr;
    gap: 2rem;
    margin-bottom: 2rem;
}
@media (max-width: 700px) {
    .creator-layout { grid-template-columns: 1fr; }
}
.preview-panel { display: flex; flex-direction: column; align-items: center; }
.preview-frame {
    width: 200px;
    height: 280px;
    background: #2a1f24;
    border: 3px solid #6b5a52;
    border-radius: 8px;
    padding: 1rem;
    position: relative;
    overflow: hidden;
}
.avatar-preview {
    width: 100%;
    height: 100%;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
}
.avatar-layer {
    position: absolute;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 4rem;
}
.preview-label {
    margin-top: 1rem;
    font-style: italic;
    color: #b8a9a0;
}
.options-panel { display: flex; flex-direction: column; gap: 1.5rem; }
.option-group {
    background: #2a1f24;
    padding: 1rem;
    border-radius: 8px;
}
.option-label {
    display: block;
    font-family: 'Special Elite', monospace;
    font-size: 0.85rem;
    color: #b8a9a0;
    margin-bottom: 0.5rem;
    text-transform: uppercase;
    letter-spacing: 2px;
}
.option-row { display: flex; gap: 0.5rem; flex-wrap: wrap; }
.swatch {
    width: 40px;
    height: 40px;
    border: 3px solid transparent;
    border-radius: 50%;
    cursor: pointer;
    transition: all 150ms ease;
    padding: 0;
}
.swatch:hover, .swatch.selected {
    border-color: #ffd700;
    transform: scale(1.1);
}
.icon-btn, .outfit-btn {
    width: 50px;
    height: 50px;
    background: #1a1216;
    border: 2px solid #6b5a52;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 150ms ease;
    padding: 0;
}
.icon-btn:hover, .icon-btn.selected,
.outfit-btn:hover, .outfit-btn.selected {
    border-color: #ff4d6d;
    background: rgba(255, 77, 109, 0.2);
}
.creator-actions { display: flex; justify-content: center; gap: 1.5rem; }

/* Date Select Screen */
#screen-dateselect {
    background: 
        radial-gradient(ellipse at 20% 50%, rgba(255, 77, 109, 0.1) 0%, transparent 40%),
        radial-gradient(ellipse at 80% 50%, rgba(78, 205, 196, 0.1) 0%, transparent 40%),
        #1a1216;
    padding: 1.5rem;
}
.dateselect-container { width: 100%; max-width: 1000px; text-align: center; }
.screen-subtitle { color: #b8a9a0; margin-bottom: 2rem; font-style: italic; }
.date-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 2rem;
    margin-bottom: 2rem;
}
.date-card {
    background: #2a1f24;
    border-radius: 12px;
    padding: 1.5rem;
    border: 2px solid #6b5a52;
    transition: all 300ms ease;
    display: flex;
    flex-direction: column;
    align-items: center;
}
.date-card:hover {
    border-color: #ff4d6d;
    transform: translateY(-4px);
    box-shadow: 0 10px 40px rgba(255, 77, 109, 0.2);
}
.card-portrait {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 1rem;
    font-size: 3rem;
}
.incel-portrait { background: linear-gradient(135deg, #4a5568, #2d3748); border: 3px solid #e53e3e; }
.femcel-portrait { background: linear-gradient(135deg, #553c9a, #44337a); border: 3px solid #d53f8c; }
.card-name {
    font-family: 'Special Elite', monospace;
    font-size: 1.3rem;
    letter-spacing: 3px;
    margin-bottom: 0.5rem;
}
.card-bio {
    font-size: 0.95rem;
    color: #b8a9a0;
    font-style: italic;
    margin-bottom: 1rem;
    line-height: 1.5;
}
.card-traits { list-style: none; text-align: left; font-size: 0.85rem; margin-bottom: 1rem; }
.card-traits li { padding: 0.25rem 0; color: #b8a9a0; }
.btn-select-date {
    font-family: 'Special Elite', monospace;
    padding: 0.5rem 1.5rem;
    background: transparent;
    border: 2px solid #ff4d6d;
    color: #ff4d6d;
    border-radius: 4px;
    cursor: pointer;
    text-transform: uppercase;
    letter-spacing: 2px;
    transition: all 150ms ease;
}
.btn-select-date:hover {
    background: #ff4d6d;
    color: white;
}

/* Game Screen */
#screen-game {
    position: relative;
    background: linear-gradient(180deg, #1a0a0f 0%, #2a1520 30%, #3a2030 60%, #1a0a0f 100%);
}
#screen-game.active {
    display: block;
}
.stats-hud {
    position: absolute;
    top: 1rem;
    left: 1rem;
    display: flex;
    gap: 1.5rem;
    z-index: 100;
    background: rgba(0, 0, 0, 0.7);
    padding: 0.5rem 1rem;
    border-radius: 8px;
}
.stat { display: flex; align-items: center; gap: 0.25rem; font-family: 'Space Mono', monospace; font-size: 0.9rem; }
.stat-icon { font-size: 1.2rem; }
.stat-label { color: #b8a9a0; }
.stat-value { color: #ffd700; font-weight: bold; }
.sprite-layer {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
    padding: 0 5%;
    padding-bottom: 220px;
    z-index: 10;
}
.sprite-placeholder {
    width: 180px;
    height: 300px;
    background: #2a1f24;
    border: 2px dashed #6b5a52;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 4rem;
    transition: opacity 150ms ease;
}
.dialogue-container {
    position: absolute;
    bottom: 0; left: 0;
    width: 100%;
    padding: 1.5rem;
    z-index: 50;
}
.dialogue-box {
    background: rgba(15, 10, 12, 0.95);
    border: 2px solid #ff4d6d;
    border-radius: 8px;
    padding: 1.5rem;
    max-width: 900px;
    margin: 0 auto;
    box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.5);
}
.speaker-name {
    font-family: 'Special Elite', monospace;
    font-size: 1rem;
    color: #ff4d6d;
    text-transform: uppercase;
    letter-spacing: 3px;
    margin-bottom: 0.5rem;
}
.dialogue-text { font-size: 1.1rem; line-height: 1.7; color: #fff8f0; min-height: 60px; }
.choices-container {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    max-width: 900px;
    margin: 1rem auto 0;
}
.choice-btn {
    font-family: 'Crimson Pro', Georgia, serif;
    padding: 1rem 1.5rem;
    background: rgba(255, 77, 109, 0.1);
    border: 1px solid #ff4d6d;
    border-radius: 4px;
    color: #fff8f0;
    cursor: pointer;
    text-align: left;
    font-size: 1rem;
    text-transform: none;
    letter-spacing: normal;
    transition: all 150ms ease;
}
.choice-btn:hover {
    background: rgba(255, 77, 109, 0.3);
    transform: translateX(4px);
}
.btn-menu {
    position: absolute;
    bottom: 1.5rem;
    right: 1.5rem;
    font-family: 'Space Mono', monospace;
    padding: 0.5rem 1rem;
    background: rgba(0, 0, 0, 0.7);
    border: 1px solid #6b5a52;
    border-radius: 4px;
    color: #b8a9a0;
    cursor: pointer;
    z-index: 60;
    font-size: 0.9rem;
    text-transform: none;
    letter-spacing: normal;
}
.btn-menu:hover { border-color: #fff8f0; color: #fff8f0; }

/* Ending Screen */
#screen-ending {
    background: radial-gradient(ellipse at center, rgba(255, 215, 0, 0.05) 0%, transparent 50%), #1a1216;
    padding: 1.5rem;
}
.ending-container { width: 100%; max-width: 500px; text-align: center; }
.ending-header { margin-bottom: 2rem; }
.ending-title { font-family: 'Special Elite', monospace; font-size: 2rem; letter-spacing: 4px; margin-bottom: 1rem; }
.ending-text { color: #b8a9a0; font-style: italic; font-size: 1.1rem; }
.receipt-container { margin-bottom: 2rem; }
.receipt {
    background: #f5f0e1;
    color: #2c2416;
    font-family: 'Space Mono', monospace;
    padding: 1.5rem;
    border-radius: 4px;
    text-align: left;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
}
.receipt-header { text-align: center; margin-bottom: 1rem; }
.receipt-restaurant { font-size: 1rem; font-weight: bold; }
.receipt-tagline { font-size: 0.75rem; color: #8b4513; }
.receipt-divider { color: #8b4513; font-size: 0.7rem; letter-spacing: -1px; margin: 0.5rem 0; }
.receipt-items { margin: 1rem 0; }
.receipt-item { display: flex; justify-content: space-between; font-size: 0.85rem; padding: 0.25rem 0; }
.receipt-item-label { flex: 1; padding-right: 1rem; }
.receipt-item-cost { text-align: right; white-space: nowrap; }
.receipt-footer { text-align: center; }
.receipt-total, .receipt-balance { font-weight: bold; font-size: 1rem; }
.receipt-balance { color: #ff3333; }
.receipt-balance.positive { color: green; }
.receipt-message { font-size: 0.75rem; font-style: italic; margin-top: 1rem; color: #8b4513; }
.ending-actions { display: flex; flex-direction: column; gap: 1rem; }

/* Modal */
.modal {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}
.modal.hidden { display: none; }
.modal-content {
    background: #2a1f24;
    border: 2px solid #ff4d6d;
    border-radius: 12px;
    padding: 2rem;
    width: 90%;
    max-width: 350px;
    position: relative;
    text-align: center;
}
.btn-close {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background: none;
    border: none;
    color: #b8a9a0;
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0;
}
.btn-close:hover { color: #ff4d6d; }
.modal-title { font-family: 'Special Elite', monospace; letter-spacing: 3px; margin-bottom: 1.5rem; }
.modal-buttons { display: flex; flex-direction: column; }

/* Phone Button */
.btn-phone {
    position: absolute;
    top: 1rem;
    right: 1rem;
    width: 44px;
    height: 44px;
    background: rgba(0, 0, 0, 0.7);
    border: 1px solid #6b5a52;
    border-radius: 8px;
    font-size: 1.3rem;
    cursor: pointer;
    z-index: 100;
    transition: all 150ms ease;
    display: flex;
    align-items: center;
    justify-content: center;
}
.btn-phone:hover {
    border-color: #ff4d6d;
    background: rgba(255, 77, 109, 0.2);
}

/* Phone Overlay */
.phone-overlay {
    position: fixed;
    top: 50%;
    right: 20px;
    transform: translateY(-50%);
    z-index: 500;
    pointer-events: none;
}
.phone-overlay.hidden { display: none; }
.phone-frame {
    width: 280px;
    height: 520px;
    background: #1a1a1a;
    border-radius: 32px;
    padding: 8px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5), 0 0 0 2px #333;
    pointer-events: auto;
    position: relative;
}
.phone-close {
    position: absolute;
    top: -12px;
    right: -12px;
    width: 32px;
    height: 32px;
    background: #ff4d6d;
    border: none;
    border-radius: 50%;
    color: white;
    font-size: 1rem;
    cursor: pointer;
    z-index: 10;
    display: flex;
    align-items: center;
    justify-content: center;
}
.phone-close:hover { background: #ff6b8a; }
.phone-notch {
    width: 80px;
    height: 20px;
    background: #1a1a1a;
    border-radius: 0 0 12px 12px;
    margin: 0 auto 8px;
    position: relative;
    z-index: 5;
}
.phone-screen {
    width: 100%;
    height: calc(100% - 28px);
    background: linear-gradient(180deg, #2a1f24 0%, #1a1216 100%);
    border-radius: 24px;
    overflow: hidden;
}
.dating-app {
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 12px;
}
.app-header {
    font-family: 'Special Elite', monospace;
    font-size: 0.9rem;
    color: #ff4d6d;
    letter-spacing: 1px;
    margin-bottom: 12px;
}
.profile-photo {
    width: 100px;
    height: 100px;
    background: linear-gradient(135deg, #4a5568, #2d3748);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 3rem;
    margin-bottom: 12px;
    border: 3px solid #ff4d6d;
}
.profile-name {
    font-family: 'Special Elite', monospace;
    font-size: 1.2rem;
    color: #fff8f0;
    letter-spacing: 2px;
}
.profile-age {
    font-size: 0.85rem;
    color: #b8a9a0;
    margin-bottom: 12px;
}
.profile-bio {
    font-size: 0.8rem;
    color: #b8a9a0;
    text-align: center;
    font-style: italic;
    line-height: 1.4;
    margin-bottom: 12px;
    padding: 0 8px;
}
.profile-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    justify-content: center;
    margin-bottom: 12px;
}
.profile-tag {
    background: rgba(255, 77, 109, 0.2);
    border: 1px solid #ff4d6d;
    border-radius: 12px;
    padding: 4px 10px;
    font-size: 0.7rem;
    color: #ff4d6d;
}
.match-status {
    margin-top: auto;
    background: linear-gradient(135deg, #ff4d6d, #ff6b8a);
    color: white;
    padding: 8px 20px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: bold;
}
    </style>
</head>
<body>
    <!-- TITLE SCREEN -->
    <div id="screen-title" class="screen active">
        <div class="title-container">
            <div class="title-decoration"></div>
            <h1 class="game-title">GENDER WAR</h1>
            <p class="game-subtitle">A Dating Disaster Simulator</p>
            <div class="title-decoration"></div>
            <button id="btn-start" class="btn-primary pulse">START GAME</button>
            <p class="title-warning">‚ö†Ô∏è No refunds on emotional damage ‚ö†Ô∏è</p>
        </div>
    </div>

    <!-- CHARACTER CREATOR SCREEN -->
    <div id="screen-creator" class="screen">
        <div class="creator-container">
            <h2 class="screen-title">CREATE YOUR AVATAR</h2>
            <div class="creator-layout">
                <div class="preview-panel">
                    <div class="preview-frame">
                        <div id="avatar-preview" class="avatar-preview">
                            <div class="avatar-layer" id="layer-skin"></div>
                            <div class="avatar-layer" id="layer-outfit"></div>
                            <div class="avatar-layer" id="layer-mouth"></div>
                            <div class="avatar-layer" id="layer-eyes"></div>
                        </div>
                    </div>
                    <p class="preview-label">Your Date Night Look</p>
                </div>
                <div class="options-panel">
                    <div class="option-group">
                        <label class="option-label">Skin Tone</label>
                        <div class="option-row" id="skin-options">
                            <button class="swatch selected" data-option="skin" data-value="0" style="background: #FFDFC4"></button>
                            <button class="swatch" data-option="skin" data-value="1" style="background: #F0C08A"></button>
                            <button class="swatch" data-option="skin" data-value="2" style="background: #CD9A6D"></button>
                            <button class="swatch" data-option="skin" data-value="3" style="background: #8D5524"></button>
                            <button class="swatch" data-option="skin" data-value="4" style="background: #4A2912"></button>
                        </div>
                    </div>
                    <div class="option-group">
                        <label class="option-label">Eyes</label>
                        <div class="option-row" id="eye-options">
                            <button class="icon-btn selected" data-option="eyes" data-value="0">üëÅÔ∏è</button>
                            <button class="icon-btn" data-option="eyes" data-value="1">‚óâ</button>
                            <button class="icon-btn" data-option="eyes" data-value="2">‚ó†</button>
                            <button class="icon-btn" data-option="eyes" data-value="3">‚úø</button>
                        </div>
                    </div>
                    <div class="option-group">
                        <label class="option-label">Mouth</label>
                        <div class="option-row" id="mouth-options">
                            <button class="icon-btn selected" data-option="mouth" data-value="0">‚Äø</button>
                            <button class="icon-btn" data-option="mouth" data-value="1">‚Äï</button>
                            <button class="icon-btn" data-option="mouth" data-value="2">‚ó°</button>
                            <button class="icon-btn" data-option="mouth" data-value="3">üëÑ</button>
                        </div>
                    </div>
                    <div class="option-group">
                        <label class="option-label">Outfit</label>
                        <div class="option-row" id="outfit-options">
                            <button class="outfit-btn selected" data-option="outfit" data-value="0">üëî</button>
                            <button class="outfit-btn" data-option="outfit" data-value="1">üëó</button>
                            <button class="outfit-btn" data-option="outfit" data-value="2">üß•</button>
                            <button class="outfit-btn" data-option="outfit" data-value="3">üëï</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="creator-actions">
                <button id="btn-back-title" class="btn-secondary">‚Üê Back</button>
                <button id="btn-confirm-creator" class="btn-primary">Confirm Look ‚Üí</button>
            </div>
        </div>
    </div>

    <!-- DATE SELECTION SCREEN -->
    <div id="screen-dateselect" class="screen">
        <div class="dateselect-container">
            <h2 class="screen-title">CHOOSE YOUR DISASTER</h2>
            <p class="screen-subtitle">Select your date for tonight's regrettable evening</p>
            <div class="date-cards">
                <div class="date-card">
                    <div class="card-portrait incel-portrait"><img src="sprites/wolf_neutral.png" alt="incel" style="width:100%;height:100%;object-fit:contain;"></div>
                    <h3 class="card-name">THE INCEL</h3>
                    <p class="card-bio">"I've done the math. Women only date the top 20% of men. I'm a 6 who deserves an 8."</p>
                    <ul class="card-traits">
                        <li>üéÆ Hobby: Rating women on spreadsheets</li>
                        <li>üìö Last read: Andrew Tate tweet thread</li>
                        <li>üö© Vibe: Peer-reviewed YouTube videos</li>
                    </ul>
                    <button class="btn-select-date" data-route="incel">Date Him</button>
                </div>
                <div class="date-card">
                    <div class="card-portrait femcel-portrait"><img src="sprites/cat_neutral.png" alt="femcel" style="width:100%;height:100%;object-fit:contain;"></div>
                    <h3 class="card-name">THE FEMCEL</h3>
                    <p class="card-bio">"What's your credit score? Asking for me, not a friend."</p>
                    <ul class="card-traits">
                        <li>üíé Hobby: Screening men's watch collections</li>
                        <li>üì± Last search: "Is $200k a good salary"</li>
                        <li>üö© Vibe: Your net worth is your love language</li>
                    </ul>
                    <button class="btn-select-date" data-route="femcel">Date Her</button>
                </div>
            </div>
            <button id="btn-back-creator" class="btn-secondary">‚Üê Change Look</button>
        </div>
    </div>

    <!-- PART 2 DATE SELECTION SCREEN -->
    <div id="screen-dateselect2" class="screen">
        <div class="dateselect-container">
            <h2 class="screen-title">ROUND TWO</h2>
            <p class="screen-subtitle">Word travels fast. Choose your next disaster.</p>
            <div class="date-cards">
                <div class="date-card">
                    <div class="card-portrait" style="background: linear-gradient(135deg, #3d5a80, #293241); border: 3px solid #98c1d9;"><img src="sprites/dog_neutral.png" alt="ally" style="width:100%;height:100%;object-fit:contain;"></div>
                    <h3 class="card-name">THE ALLY</h3>
                    <p class="card-bio">"I've done the work. I go to therapy. I process. Why are you being defensive?"</p>
                    <ul class="card-traits">
                        <li>üßò Hobby: Men's circle breathwork</li>
                        <li>üìñ Last read: Bell Hooks (for clout)</li>
                        <li>üö© Vibe: Weaponized vulnerability</li>
                    </ul>
                    <button class="btn-select-date" data-route="performative" data-part="2">Date Him</button>
                </div>
                <div class="date-card">
                    <div class="card-portrait" style="background: linear-gradient(135deg, #e0aaff, #9d4edd); border: 3px solid #c77dff;"><img src="sprites/fox_neutral.png" alt="bop" style="width:100%;height:100%;object-fit:contain;"></div>
                    <h3 class="card-name">THE BOP</h3>
                    <p class="card-bio">"Sorry what? *looks up from phone* Oh yeah I'm listening. My Uber is 3 min away btw."</p>
                    <ul class="card-traits">
                        <li>üì± Hobby: Being perceived</li>
                        <li>üí¨ Last text: "omg sorry just saw this" (3 weeks ago)</li>
                        <li>üö© Vibe: Attention as currency</li>
                    </ul>
                    <button class="btn-select-date" data-route="bop" data-part="2">Date Her</button>
                </div>
            </div>
            <button id="btn-back-ending" class="btn-secondary">‚Üê Back</button>
        </div>
    </div>

    <!-- GAME SCREEN -->
    <div id="screen-game" class="screen">
        <div class="stats-hud">
            <div class="stat">
                <span class="stat-icon">üí∞</span>
                <span class="stat-label">Money:</span>
                <span class="stat-value" id="stat-money">$100</span>
            </div>
            <div class="stat">
                <span class="stat-icon">üò§</span>
                <span class="stat-label">Patience:</span>
                <span class="stat-value" id="stat-patience">10</span>
            </div>
        </div>
        <button id="btn-phone" class="btn-phone">üì±</button>
        <div class="sprite-layer">
            <div class="sprite-placeholder" id="sprite-left">üò§</div>
            <div class="sprite-placeholder" id="sprite-right">üôÇ</div>
        </div>
        <div class="dialogue-container">
            <div class="dialogue-box">
                <div class="speaker-name" id="speaker-name">???</div>
                <div class="dialogue-text" id="dialogue-text">Loading...</div>
            </div>
            <div class="choices-container" id="choices-container"></div>
        </div>
        <button id="btn-menu" class="btn-menu">‚ò∞ Menu</button>
    </div>

    <!-- ENDING SCREEN -->
    <div id="screen-ending" class="screen">
        <div class="ending-container">
            <div class="ending-header">
                <h2 class="ending-title" id="ending-title">DATE OVER</h2>
                <p class="ending-text" id="ending-text">How did it go?</p>
            </div>
            <div class="receipt-container">
                <div class="receipt">
                    <div class="receipt-header">
                        <p class="receipt-restaurant">‚ú¶ LE DISASTER CAF√â ‚ú¶</p>
                        <p class="receipt-tagline">Where Romance Goes To Die</p>
                        <p class="receipt-divider">================================</p>
                    </div>
                    <div class="receipt-items" id="receipt-items"></div>
                    <div class="receipt-footer">
                        <p class="receipt-divider">================================</p>
                        <p class="receipt-total">TOTAL: <span id="receipt-total">$0</span></p>
                        <p class="receipt-balance">REMAINING: <span id="receipt-balance">$0</span></p>
                        <p class="receipt-divider">--------------------------------</p>
                        <p class="receipt-message" id="receipt-message">Thank you for dining with us!</p>
                    </div>
                </div>
            </div>
            <div class="ending-actions">
                <button id="btn-next-date" class="btn-primary hidden">üî• Next Date (Part 2)</button>
                <button id="btn-final-phase" class="btn-primary hidden">üëÅÔ∏è The Convergence (Final)</button>
                <button id="btn-play-again" class="btn-secondary">Play Again</button>
                <button id="btn-new-date" class="btn-secondary">Choose Different Date</button>
                <button id="btn-new-char" class="btn-secondary">New Character</button>
            </div>
        </div>
    </div>

    <!-- MENU MODAL -->
    <div id="menu-modal" class="modal hidden">
        <div class="modal-content">
            <button id="btn-close-menu" class="btn-close">‚úï</button>
            <h3 class="modal-title">PAUSE</h3>
            <div class="modal-buttons">
                <button id="btn-resume" class="btn-modal">Resume</button>
                <button id="btn-restart" class="btn-modal">Restart Date</button>
                <button id="btn-return-select" class="btn-modal">Main Menu</button>
            </div>
        </div>
    </div>

    <!-- PHONE OVERLAY -->
    <div id="phone-overlay" class="phone-overlay hidden">
        <div class="phone-frame">
            <button id="btn-close-phone" class="phone-close">‚úï</button>
            <div class="phone-notch"></div>
            <div class="phone-screen">
                <div class="dating-app">
                    <div class="app-header">üíî DisasterMatch</div>
                    <div class="profile-photo" id="phone-photo">üò§</div>
                    <div class="profile-name" id="phone-name">???</div>
                    <div class="profile-age" id="phone-age">Age: ??</div>
                    <div class="profile-bio" id="phone-bio">Loading...</div>
                    <div class="profile-tags" id="phone-tags"></div>
                    <div class="match-status">‚úì You matched!</div>
                </div>
            </div>
        </div>
    </div>

<script>
// ===== DIALOGUE DATA =====
const INCEL_ROUTE = {
    'incel_start': {
        speaker: 'INCEL', text: "*doesn't stand up* You're 47 minutes late. I have a spreadsheet. Time is money, and statistically, women waste both.",
        dateExpression: 'neutral', playerExpression: 'concerned',
        choices: [
            { label: "I'm literally 5 minutes early.", nextId: 'incel_early', effects: { patience: -1 } },
            { label: "Sorry, traffic.", nextId: 'incel_apology' },
            { label: "Your watch might be wrong.", nextId: 'incel_clocks', effects: { patience: -2 } }
        ]
    },
    'incel_early': {
        speaker: 'INCEL', text: "Classic DARVO. Deny, Attack, Reverse Victim and Offender. I learned about this from a 4-hour YouTube essay.",
        dateExpression: 'angry',
        choices: [
            { label: "Let's just order food.", nextId: 'incel_menu' },
            { label: "I'm going to leave now.", nextId: 'incel_buffer_friction' }
        ]
    },
    'incel_buffer_friction': {
        speaker: 'WAITER',
        text: "Good evening, can I get you two start‚Äî oh. Is everything okay here?",
        choices: [
            { label: "We're done.", nextId: 'ending_immediate_leave' },
            { label: "*already grabbing coat*", nextId: 'ending_immediate_leave' }
        ]
    },
    'incel_apology': {
        speaker: 'INCEL', text: "Accountability. Rare in a female. You're already in the top 12% of my matches. Don't let it go to your head.",
        choices: [
            { label: "...thank you?", nextId: 'incel_menu' },
            { label: "Can you not say 'female'?", nextId: 'incel_females' }
        ]
    },
    'incel_clocks': {
        speaker: 'INCEL', text: "Interesting. Questioning objective reality. Did your last boyfriend‚Äîsorry, 'situationship'‚Äîteach you that? Let me guess: 6'2\", finance bro, treated you like garbage?",
        dateExpression: 'angry',
        choices: [
            { label: "Who hurt you?", nextId: 'incel_chad' },
            { label: "Can we just order?", nextId: 'incel_menu' }
        ]
    },
    'incel_chad': {
        speaker: 'INCEL', text: "Society hurt me. The 80/20 rule hurt me. Women choosing the top 20% of men while guys like me‚Äîwho actually READ‚Äîrot. But you wouldn't understand hypergamy.",
        dateExpression: 'angry',
        choices: [{ label: "I need alcohol immediately.", nextId: 'incel_menu', effects: { patience: -1 } }]
    },
    'incel_females': {
        speaker: 'INCEL', text: "'Female' is biologically accurate. 'Woman' is a social construct. I don't make the rules. Actually, I do make the rules, because I've done the research.",
        dateExpression: 'angry',
        choices: [
            { label: "'Woman' is fine, actually.", nextId: 'incel_menu', effects: { patience: -1 } },
            { label: "Menu. Now. Please.", nextId: 'incel_menu' }
        ]
    },
    'incel_menu': {
        speaker: 'WAITER', text: "Good evening. Can I start you off with drinks, or would you prefer to continue... whatever this is?",
        choices: [
            { label: "Wine. Large.", nextId: 'incel_after_order', effects: { money: -12 }, receiptLines: [{ label: 'House Wine (escape juice)', cost: 12 }] },
            { label: "Just water.", nextId: 'incel_after_order' },
            { label: "Strongest thing you have. Double.", nextId: 'incel_after_order', effects: { money: -18 }, receiptLines: [{ label: 'Quadruple Whiskey', cost: 18 }] }
        ]
    },
    'incel_after_order': {
        speaker: 'INCEL', text: "So. I've developed an algorithm that predicts dating success based on canthal tilt, wrist circumference, and crypto portfolio. Want to see where you rank?",
        choices: [
            { label: "Sure, show me the algorithm.", nextId: 'incel_spreadsheet' },
            { label: "Can we have a normal conversation?", nextId: 'incel_normal_talk' },
            { label: "I need to use the restroom.", nextId: 'ending_bathroom_escape' }
        ]
    },
    'incel_spreadsheet': {
        speaker: 'INCEL', text: "*opens laptop* See this column? 'Likelihood of responding.' You're highlighted yellow‚Äî'statistical anomaly.' Most women in your looksmatch range ghost me within 3 messages.",
        choices: [
            { label: "I'm... flattered?", nextId: 'ending_spreadsheet' },
            { label: "This is genuinely unhinged.", nextId: 'ending_unhinged' }
        ]
    },
    'incel_normal_talk': {
        speaker: 'INCEL', text: "'Normal conversation.' You mean the bluepilled small talk that Chads use to manipulate women into situationships? Fine. What's your... favorite color, I guess.",
        dateExpression: 'angry',
        choices: [
            { label: "Blue.", nextId: 'ending_unexpected' },
            { label: "This is not working.", nextId: 'ending_honest_exit' }
        ]
    },
    'ending_immediate_leave': {
        speaker: 'PLAYER', text: "You grab your coat and leave before the bread arrives. A new personal record.",
        isEnding: true, endingTitle: 'SIGMA GRINDSET', endingText: 'You escaped in 47 seconds. He will make a podcast episode about this.',
        receiptLines: [{ label: 'Valet tip (for running)', cost: 5 }]
    },
    'ending_bathroom_escape': {
        speaker: 'PLAYER', text: "You climb out the bathroom window. The toilet seat was up. Of course it was.",
        isEnding: true, endingTitle: 'TACTICAL RETREAT', endingText: 'The bathroom escape: older than feminism, twice as effective.',
        receiptLines: [{ label: 'Dignity (lost)', cost: 0 }, { label: 'Window cleaning fee', cost: 25 }]
    },
    'ending_spreadsheet': {
        speaker: 'INCEL', text: "*stops typing* Wait. You're... actually interested in my methodology? This is unprecedented. I need to add a new column. 'Intellectually curious females.' Population: 1.",
        isEnding: true, endingTitle: 'DATA POINT', endingText: 'You are now Exhibit A in his manifesto.',
        receiptLines: [{ label: 'Appetizer (never arrived)', cost: 15 }]
    },
    'ending_unhinged': {
        speaker: 'INCEL', text: "UNHINGED? I have SOURCES. Peer-reviewed YouTube videos. You're just mad because the data doesn't lie and the data says you're a 6 who thinks she's an 8‚Äî",
        isEnding: true, endingTitle: 'MELTDOWN ARC', endingText: 'Security escorted him out. He live-tweeted the whole thing.',
        receiptLines: [{ label: 'Table damage deposit', cost: 50 }]
    },
    'ending_unexpected': {
        speaker: 'INCEL', text: "Blue? *long pause* That's... my favorite too. It's the color of logic. And sadness. *clears throat* Do you want to split the tendies?",
        isEnding: true, endingTitle: 'ANOMALY DETECTED', endingText: 'Against all odds, chicken tenders brought you together. Love is statistically improbable.',
        receiptLines: [{ label: 'Chicken tenders (shared)', cost: 14 }, { label: 'Hope (restored)', cost: 0 }]
    },
    'ending_honest_exit': {
        speaker: 'PLAYER', text: "I appreciate you coming out, but I think we want different things. Good luck with your algorithm.",
        isEnding: true, endingTitle: 'GRACEFUL EXIT', endingText: 'You left with dignity. He added you to the "polite rejection" spreadsheet.',
        receiptLines: [{ label: 'Water (dignity intact)', cost: 0 }]
    }
};

const FEMCEL_ROUTE = {
    'femcel_start': {
        speaker: 'FEMCEL', text: "*looking at phone* Oh. You came. *glances up, scans you head to toe* What's your height? Net worth? Credit score? I'm not shallow, I just have standards.",
        playerExpression: 'concerned',
        choices: [
            { label: "Why would I not show up?", nextId: 'femcel_suspicious' },
            { label: "Nice to meet you too.", nextId: 'femcel_sarcasm' },
            { label: "Should I leave?", nextId: 'femcel_leave_offer' }
        ]
    },
    'femcel_suspicious': {
        speaker: 'FEMCEL', text: "Because men with Honda Civics usually flake. What do you drive? Actually, don't tell me. If it's not German, I don't want to know. I'm manifesting abundance.",
        dateExpression: 'smirk',
        choices: [
            { label: "That's... a lot of times to get back together.", nextId: 'femcel_derek' },
            { label: "I'm not Derek.", nextId: 'femcel_not_derek' }
        ]
    },
    'femcel_sarcasm': {
        speaker: 'FEMCEL', text: "Sarcasm. Interesting. Most men just trauma dump or mention crypto within 5 minutes. *puts phone face-down* Is that shirt from Target? Be honest.",
        dateExpression: 'smirk',
        choices: [
            { label: "I'll try to keep it.", nextId: 'femcel_menu' },
            { label: "I don't need your attention.", nextId: 'femcel_impressed' }
        ]
    },
    'femcel_leave_offer': {
        speaker: 'FEMCEL', text: "Not even going to fight for it? That's either low effort or low income. Both are icks. A man who wanted me would stay and order the tasting menu.",
        choices: [
            { label: "I'll stay if you want me to.", nextId: 'femcel_menu' },
            { label: "Okay, bye then.", nextId: 'femcel_buffer_friction_exit' }
        ]
    },
    'femcel_buffer_friction_exit': {
        speaker: 'WAITER',
        text: "Good evening, can I start you off with‚Äî leaving already?",
        choices: [
            { label: "Just the exit, thanks.", nextId: 'ending_mutual_disinterest' },
            { label: "*already walking away*", nextId: 'ending_mutual_disinterest' }
        ]
    },
    'femcel_derek': {
        speaker: 'FEMCEL', text: "Your car reflects your ambition. My ex drove a BMW but leased it. LEASED. The deception. I deserve a man who owns assets. Preferably appreciating ones.",
        dateExpression: 'angry',
        choices: [
            { label: "I could cover the $47.", nextId: 'femcel_buffer_friction_closure', effects: { money: -47 }, receiptLines: [{ label: "Proving financial stability", cost: 47 }] },
            { label: "Let's talk about something else.", nextId: 'femcel_menu' }
        ]
    },
    'femcel_buffer_friction_closure': {
        speaker: 'WAITER',
        text: "I'll just... give you two a moment. *steps back*",
        choices: [
            { label: "We're having a moment.", nextId: 'ending_bought_closure' },
            { label: "*slides card across table*", nextId: 'ending_bought_closure' }
        ]
    },
    'femcel_not_derek': {
        speaker: 'FEMCEL', text: "*squints* That's what a man without a 401k would say. What's your ring budget? Hypothetically. Because if it's under 3 months salary, we're done here.",
        dateExpression: 'smirk',
        choices: [
            { label: "I literally don't know Derek.", nextId: 'femcel_menu' },
            { label: "Maybe I AM Derek.", nextId: 'femcel_buffer_friction_reveal' }
        ]
    },
    'femcel_buffer_friction_reveal': {
        speaker: 'WAITER',
        text: "Ma'am, please, the other guests are‚Äî ma'am?",
        choices: [
            { label: "This doesn't concern you.", nextId: 'ending_derek_reveal' },
            { label: "*chaos escalates*", nextId: 'ending_derek_reveal' }
        ]
    },
    'femcel_impressed': {
        speaker: 'FEMCEL', text: "*actually looks up* Okay. A man who doesn't immediately seek my validation? That's either secure attachment or family money. Either way, intriguing.",
        dateExpression: 'smirk',
        choices: [{ label: "I have my moments.", nextId: 'femcel_menu' }]
    },
    'femcel_menu': {
        speaker: 'WAITER', text: "Good evening! What can I get you started with?",
        choices: [
            { label: "A bottle of wine to share?", nextId: 'femcel_wine', effects: { money: -30 }, receiptLines: [{ label: 'Wine (trust exercise)', cost: 30 }] },
            { label: "I'll just have water.", nextId: 'femcel_water' },
            { label: "Two of your strongest cocktails.", nextId: 'femcel_cocktails', effects: { money: -28 }, receiptLines: [{ label: 'Survival cocktails x2', cost: 28 }] }
        ]
    },
    'femcel_wine': {
        speaker: 'FEMCEL', text: "Sharing? Bold. Most men Venmo request me immediately. Which is wild because if he wanted to provide, he would. A woman should never split a check. It's science.",
        choices: [
            { label: "I'm trying to have a nice dinner.", nextId: 'ending_nice_dinner' },
            { label: "Maybe I'm just not Derek.", nextId: 'ending_not_derek_win' }
        ]
    },
    'femcel_water': {
        speaker: 'FEMCEL', text: "Water? *writes something in Notes app* Either you're sober or you're cheap. Both suggest lifestyle limitations. My cat eats high-pH salmon. She lives better than this.",
        dateExpression: 'smirk',
        choices: [
            { label: "Tell me about Empress Livia.", nextId: 'ending_cat_person' },
            { label: "Can we talk about something other than Derek and your cat?", nextId: 'ending_harsh_truth' }
        ]
    },
    'femcel_cocktails': {
        speaker: 'FEMCEL', text: "Finally. A man who understands that the cost of a drink reflects the value he places on my time. *raises glass* To men who invest in experiences.",
        dateExpression: 'smirk',
        choices: [
            { label: "To bad decisions!", nextId: 'ending_chaos' },
            { label: "To... new beginnings?", nextId: 'ending_hopeful' }
        ]
    },
    'ending_mutual_disinterest': {
        speaker: 'PLAYER', text: "You both shrug. She returns to browsing Hermes resale. You return to your reasonably-priced life.",
        isEnding: true, endingTitle: 'INSUFFICIENT FUNDS', endingText: 'She needed a provider. You needed a personality. Nobody won.',
        receiptLines: [{ label: 'Parking validation', cost: 0 }]
    },
    'ending_bought_closure': {
        speaker: 'FEMCEL', text: "*stares at card* You... didn't even hesitate? *voice softens* Do you have a diversified portfolio? A man who spends freely AND invests? I need to sit down. I'm already sitting.",
        isEnding: true, endingTitle: 'ASSET ACQUIRED', endingText: 'Your willingness to spend signaled abundance. She is now emotionally available.',
        receiptLines: [{ label: "Proving financial stability", cost: 47 }, { label: 'Emotional walls (liquidated)', cost: 0 }]
    },
    'ending_derek_reveal': {
        speaker: 'FEMCEL', text: "MILLIONAIRE? *stands up* *entire restaurant turns* WHY DIDN'T YOU LEAD WITH THAT? THE SHIRT THREW ME OFF. WE NEED TO DISCUSS ASSET PROTECTION.",
        isEnding: true, endingTitle: 'DUE DILIGENCE', endingText: 'You were lying. But she already texted her group chat about your "stealth wealth."',
        receiptLines: [{ label: 'Scene caused', cost: 0 }, { label: 'Prenup discussion (premature)', cost: 0 }]
    },
    'ending_nice_dinner': {
        speaker: 'FEMCEL', text: "*pauses* That's... disarmingly simple. No flex. No agenda. *looks away* The bread here is free, but you could have ordered the $40 appetizer. And yet. Interesting.",
        isEnding: true, endingTitle: 'DIMINISHING RETURNS', endingText: 'You offered presence over presents. She is confused but intrigued.',
        receiptLines: [{ label: 'Wine (shared)', cost: 30 }, { label: 'Emotional availability (priceless)', cost: 0 }]
    },
    'ending_not_derek_win': {
        speaker: 'FEMCEL', text: "*long pause* Like me? Not my aesthetic? Not my potential? Just... me? *quietly* That's not how this usually works. Let me recalibrate.",
        isEnding: true, endingTitle: 'MARKET CORRECTION', endingText: 'You valued her as a person, not an asset. System error. Recalculating.',
        receiptLines: [{ label: 'Wine (shared)', cost: 30 }, { label: 'Second date (pending appraisal)', cost: 0 }]
    },
    'ending_cat_person': {
        speaker: 'FEMCEL', text: "*eyes light up* Her name is Empress Livia. She eats high-pH salmon and wears Chanel collars‚Äî *two hours later* ‚Äîand her vet costs more than your rent, probably.",
        isEnding: true, endingTitle: 'LUXURY PET SYNDROME', endingText: 'The cat lives better than you. This was always the outcome.',
        receiptLines: [{ label: 'Water', cost: 0 }, { label: 'Cat lifestyle envy', cost: 0 }]
    },
    'ending_harsh_truth': {
        speaker: 'FEMCEL', text: "*stunned* Did you just... redirect the conversation? Without offering to buy something? *processing* That's either confidence or poverty. I respect it either way.",
        isEnding: true, endingTitle: 'NON-MATERIAL VALUE', endingText: 'You offered boundaries instead of purchases. She will discuss this with her therapist.',
        receiptLines: [{ label: 'Water', cost: 0 }, { label: 'Boundary setting (free)', cost: 0 }]
    },
    'ending_chaos': {
        speaker: 'FEMCEL', text: "*five drinks later* AND THEN HE BOUGHT ME CHANEL BUT IT WAS THE WRONG SIZE SO I‚Äî *both get escorted out* You're fun. Do you have a Black Amex?",
        isEnding: true, endingTitle: 'DIMINISHING LIQUIDITY', endingText: 'You got banned together. She expensed the emotional labor.',
        receiptLines: [{ label: 'Cocktails (many)', cost: 56 }, { label: 'Chaos (bonding)', cost: 0 }]
    },
    'ending_hopeful': {
        speaker: 'FEMCEL', text: "*softens* New beginnings. That's sweet. Financially naive, but sweet. *small smile* Fine. But next date, you're picking the restaurant. Choose wisely. I screenshot menus.",
        isEnding: true, endingTitle: 'PROBATIONARY PERIOD', endingText: 'Against all odds, she is cautiously optimistic. Your credit score is still being monitored.',
        receiptLines: [{ label: 'Cocktails x2', cost: 28 }, { label: 'Future (subject to review)', cost: 0 }]
    }
};

// ===== PART 2: PERFORMATIVE MALE ROUTE =====
const PERFORMATIVE_ROUTE = {
    'performative_start': {
        speaker: 'PERFORMATIVE',
        text: "*stands up, opens arms for hug* Hey! So good to finally meet you. {RUMOR} Anyway, I just want to say‚ÄîI really appreciate you showing up. Vulnerability is so important.",
        choices: [
            { label: "Nice to meet you too.", nextId: 'performative_nice' },
            { label: "We just met, no hug.", nextId: 'performative_no_hug' },
            { label: "What do you mean you 'heard'?", nextId: 'performative_heard' }
        ]
    },
    'performative_nice': {
        speaker: 'PERFORMATIVE',
        text: "I love that energy. Positive vibes only, you know? I've been doing a lot of work on myself lately. Therapy, journaling, breathwork. I'm basically a different person than I was six months ago.",
        choices: [
            { label: "That's great.", nextId: 'performative_menu' },
            { label: "What were you like before?", nextId: 'performative_before' }
        ]
    },
    'performative_no_hug': {
        speaker: 'PERFORMATIVE',
        text: "*steps back, hands up* Totally valid. Boundaries. I respect that. *pauses* Though I do think physical touch is how humans connect, but I'm not going to push. That would be toxic.",
        choices: [
            { label: "Thanks for understanding.", nextId: 'performative_menu' },
            { label: "You're still talking about it.", nextId: 'performative_still_talking', effects: { patience: -1 } }
        ]
    },
    'performative_heard': {
        speaker: 'PERFORMATIVE',
        text: "Oh, just... the apps, you know? People talk. Nothing bad! I just heard you were... *air quotes* intense. Which I think is great. Women should take up space.",
        choices: [
            { label: "I'm not 'intense.'", nextId: 'performative_intense', effects: { patience: -1 } },
            { label: "Let's just order.", nextId: 'performative_menu' }
        ]
    },
    'performative_before': {
        speaker: 'PERFORMATIVE',
        text: "Oh man, I was a mess. Total nice guy syndrome. But I've deconstructed all that. Now I lead with empathy. I actually cry now. Like, a lot. It's beautiful.",
        choices: [
            { label: "That's... good?", nextId: 'performative_menu' },
            { label: "Crying isn't a personality.", nextId: 'performative_crying', effects: { patience: -1 } }
        ]
    },
    'performative_still_talking': {
        speaker: 'PERFORMATIVE',
        text: "Wow. Okay. I'm sensing some defensiveness. That's okay. We all have armor. I just hope you can let me in eventually. No pressure though. *intense eye contact*",
        choices: [
            { label: "Can we order food?", nextId: 'performative_menu' },
            { label: "Please stop analyzing me.", nextId: 'performative_analyzing' }
        ]
    },
    'performative_intense': {
        speaker: 'PERFORMATIVE',
        text: "I hear you. And I validate that. Maybe 'intense' was the wrong word. You just seem like someone who... knows what she wants. Which intimidates lesser men. Not me though.",
        choices: [
            { label: "Okay, menu time.", nextId: 'performative_menu' }
        ]
    },
    'performative_crying': {
        speaker: 'PERFORMATIVE',
        text: "*hurt expression* That's... I'm going to be honest, that felt dismissive. I'm sharing something vulnerable and you're minimizing it. Is this a pattern for you?",
        choices: [
            { label: "I didn't mean‚Äî", nextId: 'performative_menu', effects: { patience: -1 } },
            { label: "I'm leaving.", nextId: 'performative_buffer_exit' }
        ]
    },
    'performative_analyzing': {
        speaker: 'PERFORMATIVE',
        text: "I'm not analyzing, I'm just... attuned. Emotional intelligence is my superpower. But if you need me to mask that, I can try. For you.",
        choices: [
            { label: "Just... menu.", nextId: 'performative_menu' },
            { label: "That's manipulative.", nextId: 'performative_manipulative' }
        ]
    },
    'performative_manipulative': {
        speaker: 'PERFORMATIVE',
        text: "*deep breath* Okay. I'm going to sit with that accusation. *long pause* I think you might be projecting. But I forgive you. Growth isn't linear.",
        choices: [
            { label: "ORDER. FOOD. NOW.", nextId: 'performative_menu' },
            { label: "I can't do this.", nextId: 'performative_buffer_exit' }
        ]
    },
    'performative_buffer_exit': {
        speaker: 'WAITER',
        text: "Can I get you two anything or‚Äî oh, is everything okay?",
        choices: [
            { label: "Just the check for... nothing.", nextId: 'ending_performative_escape' },
            { label: "*already standing*", nextId: 'ending_performative_escape' }
        ]
    },
    'performative_menu': {
        speaker: 'WAITER',
        text: "Good evening. What can I get you started with?",
        choices: [
            { label: "Wine, please.", nextId: 'performative_wine', effects: { money: -15 }, receiptLines: [{ label: 'Wine (coping)', cost: 15 }] },
            { label: "Just water.", nextId: 'performative_water' },
            { label: "Something strong.", nextId: 'performative_strong', effects: { money: -20 }, receiptLines: [{ label: 'Double whiskey (medicinal)', cost: 20 }] }
        ]
    },
    'performative_wine': {
        speaker: 'PERFORMATIVE',
        text: "Nice choice. I'm doing a dry month actually. For clarity. But you do you. No judgment. *clearly judging*",
        choices: [
            { label: "Cool.", nextId: 'performative_topic' },
            { label: "You're judging.", nextId: 'performative_judging' }
        ]
    },
    'performative_water': {
        speaker: 'PERFORMATIVE',
        text: "Hydration! Love it. I do cold plunges every morning. Wim Hof method. It's really helped me access my emotions. Have you tried breathwork?",
        choices: [
            { label: "No.", nextId: 'performative_topic' },
            { label: "I'm not interested in breathwork.", nextId: 'performative_breathwork' }
        ]
    },
    'performative_strong': {
        speaker: 'PERFORMATIVE',
        text: "Whoa. Rough day? You know, alcohol is actually a depressant. I can recommend some adaptogens if you want to regulate without substances.",
        choices: [
            { label: "I'm fine.", nextId: 'performative_topic' },
            { label: "Please don't.", nextId: 'performative_please_dont' }
        ]
    },
    'performative_judging': {
        speaker: 'PERFORMATIVE',
        text: "I'm not judging! I'm observing. There's a difference. My therapist says I have highly developed pattern recognition. It's a gift and a curse.",
        choices: [
            { label: "Okay.", nextId: 'performative_topic' }
        ]
    },
    'performative_breathwork': {
        speaker: 'PERFORMATIVE',
        text: "Totally valid. Not everyone is ready to heal. I just hope you find what works for you. Whenever you're ready. No timeline.",
        choices: [
            { label: "I don't need to heal.", nextId: 'performative_topic', effects: { patience: -1 } }
        ]
    },
    'performative_please_dont': {
        speaker: 'PERFORMATIVE',
        text: "*wounded* I'm just trying to help. But okay. Walls up. I see you. I still see you though. Behind the armor.",
        choices: [
            { label: "Please just talk normally.", nextId: 'performative_topic' }
        ]
    },
    'performative_topic': {
        speaker: 'PERFORMATIVE',
        text: "So what do you do for self-care? I do yoga, meditation, men's group on Thursdays. We cry and drum. It's incredibly healing.",
        choices: [
            { label: "I watch TV.", nextId: 'ending_performative_tv' },
            { label: "That sounds nice.", nextId: 'ending_performative_nice' },
            { label: "Men's group? Like Fight Club?", nextId: 'ending_performative_fight' }
        ]
    },
    'ending_performative_escape': {
        speaker: 'PERFORMATIVE',
        text: "*calls after you* I hope you find peace! I'll be here if you ever want to process this! *posts Instagram story about 'honoring my journey'*",
        isEnding: true,
        endingTitle: 'SELF-CARE SPEEDRUN',
        endingText: 'You escaped before he could recommend his therapist.',
        receiptLines: [{ label: 'Emotional labor (his)', cost: 0 }, { label: 'Your sanity (preserved)', cost: 0 }]
    },
    'ending_performative_tv': {
        speaker: 'PERFORMATIVE',
        text: "*long pause* TV. Okay. That's... valid. Dissociation can be a coping mechanism. Have you considered why you might be numbing? *reaches for your hand*",
        isEnding: true,
        endingTitle: 'PATHOLOGIZED',
        endingText: 'He diagnosed your Netflix habit as trauma.',
        receiptLines: [{ label: 'Wine', cost: 15 }, { label: 'Unsolicited therapy', cost: 0 }]
    },
    'ending_performative_nice': {
        speaker: 'PERFORMATIVE',
        text: "*beaming* Right? Men need spaces to be vulnerable. I'm basically the only emotionally evolved one in my friend group. It's lonely at the top of consciousness.",
        isEnding: true,
        endingTitle: 'ENLIGHTENED',
        endingText: 'He talked about himself for 3 more hours. You learned nothing.',
        receiptLines: [{ label: 'Water', cost: 0 }, { label: 'Time (wasted)', cost: 0 }, { label: 'His self-image (reinforced)', cost: 0 }]
    },
    'ending_performative_fight': {
        speaker: 'PERFORMATIVE',
        text: "*offended* Fight Club is toxic masculinity. We PROCESS. We hold space. Last week Marcus cried about his dad for 90 minutes and we just... witnessed him.",
        isEnding: true,
        endingTitle: 'WITNESSED',
        endingText: 'You will never get those 90 minutes back. Neither will Marcus.',
        receiptLines: [{ label: 'Drink', cost: 20 }, { label: 'Secondhand processing', cost: 0 }]
    }
};

// ===== PART 2: BOP ROUTE =====
const BOP_ROUTE = {
    'bop_start': {
        speaker: 'BOP',
        text: "*looking at phone, looks up, smiles* Oh hey! Sorry, just finishing a‚Äî *phone buzzes* one sec. *texts* Okay hi! {RUMOR} So like, what's your vibe?",
        choices: [
            { label: "My vibe?", nextId: 'bop_vibe' },
            { label: "Should I wait until you're done?", nextId: 'bop_wait' },
            { label: "Where did you hear that?", nextId: 'bop_hear' }
        ]
    },
    'bop_vibe': {
        speaker: 'BOP',
        text: "Yeah like... *phone buzzes* sorry‚Äî like what are you about? I'm a Gemini rising Scorpio moon so I need intellectual stimulation but also chaos, you know?",
        choices: [
            { label: "I don't know my chart.", nextId: 'bop_chart' },
            { label: "I'm about food. Can we order?", nextId: 'bop_menu' }
        ]
    },
    'bop_wait': {
        speaker: 'BOP',
        text: "*laughs* Oh you're like... direct. That's cute. No I'm here, I'm present. *phone lights up* It's just my group chat, they're SO funny. Okay what were you saying?",
        choices: [
            { label: "I didn't say anything yet.", nextId: 'bop_nothing' },
            { label: "Let's just order.", nextId: 'bop_menu' }
        ]
    },
    'bop_hear': {
        speaker: 'BOP',
        text: "Oh my god, everyone talks. Like, the dating scene is so small. *phone buzzes* Hold on‚Äî *voice note plays audibly* OMG. Sorry. My friend is going through it. Where were we?",
        choices: [
            { label: "Rumors about me.", nextId: 'bop_rumors' },
            { label: "Nowhere. Menu?", nextId: 'bop_menu' }
        ]
    },
    'bop_chart': {
        speaker: 'BOP',
        text: "Wait you DON'T? Okay we have to do your chart. What time were you born? *already opening app* This is so important for compatibility.",
        choices: [
            { label: "I don't know.", nextId: 'bop_dont_know' },
            { label: "Can we eat first?", nextId: 'bop_menu' }
        ]
    },
    'bop_nothing': {
        speaker: 'BOP',
        text: "Oh. *giggles* Right. Well say something! I hate awkward silences. Tell me something interesting about yourself. You have like thirty seconds go.",
        choices: [
            { label: "I'm hungry.", nextId: 'bop_menu' },
            { label: "That's a lot of pressure.", nextId: 'bop_pressure' }
        ]
    },
    'bop_rumors': {
        speaker: 'BOP',
        text: "It's nothing bad! Just like... you're intense? Or like, you have boundaries? Which is actually really hot in theory. *phone buzzes* Sorry one sec‚Äî",
        choices: [
            { label: "I'll wait.", nextId: 'bop_wait_2' },
            { label: "MENU.", nextId: 'bop_menu' }
        ]
    },
    'bop_dont_know': {
        speaker: 'BOP',
        text: "Text your mom! She'll know. Moms remember everything. My mom has my birth chart framed. It's a lot but also goals?",
        choices: [
            { label: "I'm not texting my mom.", nextId: 'bop_menu', effects: { patience: -1 } }
        ]
    },
    'bop_pressure': {
        speaker: 'BOP',
        text: "Aw no pressure! I just have like... a lot going on so I need to know if this is worth my time, you know? Not in a mean way. In an honest way.",
        choices: [
            { label: "Fair enough.", nextId: 'bop_menu' },
            { label: "Is this worth MY time?", nextId: 'bop_your_time' }
        ]
    },
    'bop_wait_2': {
        speaker: 'BOP',
        text: "*texts for 45 seconds* Okay sorry my ex is being weird. Not like EX ex, just like... we still talk. It's mature. Anyway! Food?",
        choices: [
            { label: "Sure.", nextId: 'bop_menu' }
        ]
    },
    'bop_your_time': {
        speaker: 'BOP',
        text: "*surprised* Oh wow. Okay. *puts phone face down* That was kind of hot actually. Most guys just let me walk all over them. Okay you have my attention. For now.",
        choices: [
            { label: "Let's order.", nextId: 'bop_menu' }
        ]
    },
    'bop_menu': {
        speaker: 'WAITER',
        text: "What can I get you?",
        choices: [
            { label: "Whatever's fast.", nextId: 'bop_fast', effects: { money: -18 }, receiptLines: [{ label: 'Quick appetizer', cost: 18 }] },
            { label: "Wine for the table.", nextId: 'bop_wine', effects: { money: -35 }, receiptLines: [{ label: 'Nice wine (impressively)', cost: 35 }] },
            { label: "Just water.", nextId: 'bop_water' }
        ]
    },
    'bop_fast': {
        speaker: 'BOP',
        text: "Efficient. I like it. My schedule is insane so I respect people who value time. *phone rings* Oh my god I have to take this‚Äî *walks away*",
        choices: [
            { label: "*waits*", nextId: 'bop_wait_call' },
            { label: "*leaves*", nextId: 'bop_buffer_exit' }
        ]
    },
    'bop_wine': {
        speaker: 'BOP',
        text: "Ooh nice choice. My last date ordered the house wine. I knew it wouldn't work. You can tell a lot about someone from what they order. *phone buzzes but she ignores it*",
        choices: [
            { label: "You ignored your phone.", nextId: 'bop_ignored' },
            { label: "What does my order say?", nextId: 'bop_order_meaning' }
        ]
    },
    'bop_water': {
        speaker: 'BOP',
        text: "Just water? *looks at you* Are you like... broke? Or healthy? I can't tell. Both are valid. One is more attractive though.",
        choices: [
            { label: "Healthy.", nextId: 'bop_healthy' },
            { label: "Does it matter?", nextId: 'bop_matter' }
        ]
    },
    'bop_wait_call': {
        speaker: 'BOP',
        text: "*returns after 10 minutes* Sorry! Crisis averted. My friend needed advice. I'm like the therapist of my group. Anyway where were we? Oh right, you.",
        choices: [
            { label: "I was just sitting here.", nextId: 'ending_bop_sitting' },
            { label: "Tell me about you.", nextId: 'ending_bop_about' }
        ]
    },
    'bop_buffer_exit': {
        speaker: 'WAITER',
        text: "Will your date be returning or‚Äî oh, you're leaving too?",
        choices: [
            { label: "She made her choice.", nextId: 'ending_bop_ghost' },
            { label: "*already gone*", nextId: 'ending_bop_ghost' }
        ]
    },
    'bop_ignored': {
        speaker: 'BOP',
        text: "*surprised* Oh. Yeah. I guess I did. *looks at you* Weird. I never do that. What are you doing to me? *actually present for the first time*",
        choices: [
            { label: "Just being here.", nextId: 'ending_bop_present' },
            { label: "Mind control.", nextId: 'ending_bop_joke' }
        ]
    },
    'bop_order_meaning': {
        speaker: 'BOP',
        text: "It says you're confident. Generous. Maybe trying to impress me. *smiles* It's working a little. Don't tell anyone I said that.",
        choices: [
            { label: "Your secret's safe.", nextId: 'ending_bop_secret' }
        ]
    },
    'bop_healthy': {
        speaker: 'BOP',
        text: "Healthy. Okay. I respect that. *phone buzzes, she looks at it, looks back at you* Actually you know what, this can wait. Tell me something real.",
        choices: [
            { label: "Like what?", nextId: 'ending_bop_real' }
        ]
    },
    'bop_matter': {
        speaker: 'BOP',
        text: "*pauses* Does it matter? *tilts head* I... don't know actually. That's a good question. Usually money stuff matters to me but you asked it weird.",
        choices: [
            { label: "Weird how?", nextId: 'ending_bop_weird' }
        ]
    },
    'ending_bop_ghost': {
        speaker: 'PLAYER',
        text: "She's still on the phone when you walk out. She might not notice for another hour.",
        isEnding: true,
        endingTitle: 'MUTUAL GHOSTING',
        endingText: 'Neither of you texted. Both of you were relieved.',
        receiptLines: [{ label: 'Appetizer (untouched)', cost: 18 }, { label: 'Time (unvalued)', cost: 0 }]
    },
    'ending_bop_sitting': {
        speaker: 'BOP',
        text: "Wow that sounded bitter. *laughs* Okay I deserve that. I'm a lot. I know I'm a lot. Most people can't handle it. *shrugs* Their loss usually.",
        isEnding: true,
        endingTitle: 'SELF-AWARE CHAOS',
        endingText: 'She knows what she is. She will not change.',
        receiptLines: [{ label: 'Appetizer', cost: 18 }, { label: 'Honesty (rare)', cost: 0 }]
    },
    'ending_bop_about': {
        speaker: 'BOP',
        text: "*actually pauses* Me? *phone buzzes, she silences it* Nobody asks that. They just react to me. *genuine smile* Okay. What do you want to know?",
        isEnding: true,
        endingTitle: 'BREAKTHROUGH?',
        endingText: 'For one moment, she was actually curious about being known. The phone buzzed 47 more times.',
        receiptLines: [{ label: 'Appetizer', cost: 18 }, { label: 'Momentary connection', cost: 0 }]
    },
    'ending_bop_present': {
        speaker: 'BOP',
        text: "*puts phone in purse* Just... being here. God that's annoying. Why is that working? *laughs* Okay fine. You have my attention. Actually.",
        isEnding: true,
        endingTitle: 'NOTIFICATION SILENCED',
        endingText: 'She put the phone away. This may be the first time ever. It will probably not last.',
        receiptLines: [{ label: 'Wine (shared)', cost: 35 }, { label: 'Presence (rare)', cost: 0 }]
    },
    'ending_bop_joke': {
        speaker: 'BOP',
        text: "*laughs* Mind control. Okay, funny. I like funny. My ex wasn't funny. He was hot but like, zero personality. You're like the opposite. Wait that came out wrong‚Äî",
        isEnding: true,
        endingTitle: 'BACKHANDED',
        endingText: 'She tried to compliment you. It was objectively an insult. She did not notice.',
        receiptLines: [{ label: 'Wine', cost: 35 }, { label: 'Ego damage', cost: 0 }]
    },
    'ending_bop_secret': {
        speaker: 'BOP',
        text: "*smiles genuinely* I like you. That's weird. I usually don't like people until the third date. *phone buzzes* Ugh. *silences it* Where were we?",
        isEnding: true,
        endingTitle: 'UNEXPECTED',
        endingText: 'Against all odds, you got a second date. She was only on her phone 60% of the time.',
        receiptLines: [{ label: 'Wine', cost: 35 }, { label: 'Second date (pending)', cost: 0 }]
    },
    'ending_bop_real': {
        speaker: 'BOP',
        text: "Like... anything. *leans in* Everyone performs for me. It's exhausting. I just want someone to be weird and normal at the same time. Is that you?",
        isEnding: true,
        endingTitle: 'BENEATH THE SURFACE',
        endingText: 'Under the chaos, she wanted connection. Her phone remained silent for almost five minutes.',
        receiptLines: [{ label: 'Water', cost: 0 }, { label: 'Vulnerability (glimpse)', cost: 0 }]
    },
    'ending_bop_weird': {
        speaker: 'BOP',
        text: "Like you actually don't care about impressing me? Which is... impressive? God, that's messed up. *laughs at herself* I need therapy.",
        isEnding: true,
        endingTitle: 'SELF-DIAGNOSIS',
        endingText: 'She realized something about herself. She will forget it by tomorrow.',
        receiptLines: [{ label: 'Water', cost: 0 }, { label: 'Growth (temporary)', cost: 0 }]
    }
};

// ===== PART 3: THE THEMCEL ROUTE =====
const THEM_ROUTE = {
    'themcel_start': {
        speaker: 'THEM',
        text: "Hey! So glad you could make it. We've heard a lot about you‚Äîjust from around, you know how it is. People talk. Anyway, we wanted to reach out because we think you might vibe with what we're building here.",
        choices: [
            { label: "Who are you?", nextId: 'themcel_convergence' },
            { label: "I remember all of you.", nextId: 'themcel_convergence' },
            { label: "What is this?", nextId: 'themcel_convergence' }
        ]
    },
    'themcel_convergence': {
        speaker: 'THEM',
        text: "We're kind of a mix of everyone, honestly. Some of us are really into data and patterns‚Äîknowing the stats, understanding trends. Some of us have high standards and know our worth. Some of us have options and don't settle. And we've all done the work, you know? Therapy, growth, communication skills. We just... figured out how to align on things.",
        choices: [
            { label: "That sounds... efficient.", nextId: 'themcel_explain' },
            { label: "That sounds exhausting.", nextId: 'themcel_explain' },
            { label: "Go on.", nextId: 'themcel_explain' }
        ]
    },
    'themcel_explain': {
        speaker: 'THEM',
        text: "It's not about being angry or bitter or anything. We're past that. We just have shared frameworks now. Like, we all agree on what red flags are, what healthy communication looks like, what boundaries mean. It makes everything easier. Less conflict. People get it.",
        choices: [
            { label: "Less conflict sounds nice.", nextId: 'themcel_end_war' },
            { label: "That's not less conflict, that's just conformity.", nextId: 'themcel_end_war' }
        ]
    },
    'themcel_end_war': {
        speaker: 'THEM',
        text: "Look, the dating thing? The gender stuff? We kind of... moved past it. Not in a dismissive way‚Äîwe've just processed it. We have language for everything now. Everyone's valid, everyone's boundaried, everyone's communicating their needs. It's actually really healthy.",
        choices: [
            { label: "Is that what you're offering?", nextId: 'themcel_offering' },
            { label: "That sounds kind of sterile.", nextId: 'themcel_offering' }
        ]
    },
    'themcel_offering': {
        speaker: 'THEM',
        text: "Basically, yeah. You'd be part of the group. The main chat, the hangs, the shared understanding. You'd never have to explain yourself because everyone already gets the references. Same podcasts, same takes, same way of talking about stuff. It's nice, honestly. Low friction.",
        choices: [
            { label: "What's the catch?", nextId: 'themcel_cost' }
        ]
    },
    'themcel_cost': {
        speaker: 'THEM',
        text: "There's no catch really. Just, you know, the usual stuff. Keep up with the norms, don't make things weird, be chill when people give feedback. If someone says something landed wrong, you just adjust. It's not a big deal. Most people find it's actually easier than doing their own thing.",
        choices: [
            { label: "And if I don't want to?", nextId: 'themcel_invitation' },
            { label: "That sounds manageable.", nextId: 'themcel_invitation' }
        ]
    },
    'themcel_invitation': {
        speaker: 'THEM',
        text: "Anyway, no pressure either way. Some people really thrive here, some people find it's not their thing. Both are fine. We just want to make sure everyone's on the same page. So‚Äîwould you want to be part of this?",
        choices: [
            { label: "I want to be part of this.", nextId: 'themcel_evaluation' },
            { label: "I don't think this is for me.", nextId: 'themcel_refusal_end' }
        ]
    },
    'themcel_evaluation': {
        speaker: 'THEM',
        text: "Thanks for sharing that. We're just gonna check in with the group real quick‚Äîstandard process. Everyone gets the same review. Give us one sec.",
        choices: [
            { label: "*wait*", nextId: 'themcel_decision' }
        ]
    },
    'themcel_decision': {
        speaker: 'THEM',
        text: "{INTEGRATION_RESULT}",
        choices: [
            { label: "...", nextId: '{INTEGRATION_ENDING}' }
        ]
    },
    'themcel_refusal_end': {
        speaker: 'THEM',
        text: "Totally valid. We get that this isn't for everyone, and that's okay. No hard feelings. You're always welcome to revisit if your situation changes. We'll still be here. Take care of yourself.",
        isEnding: true,
        endingTitle: 'OPTED OUT',
        endingText: 'You left the group chat. Nobody unfollowed you, but the vibe shifted.',
        receiptLines: [{ label: 'Membership (declined)', cost: 0 }, { label: 'Boundaries (respected)', cost: 0 }, { label: 'Future invite (pending)', cost: 0 }]
    },
    'themcel_acceptance_end': {
        speaker: 'THEM',
        text: "Great news‚Äîwe think you'd be a good fit. Your communication style aligns with the group, and we appreciate how you've shown up. We'll add you to the main chat. Just a heads up: we do feedback Fridays and we ask that everyone keeps things constructive. Welcome aboard.",
        isEnding: true,
        endingTitle: 'ONBOARDED',
        endingText: 'You were added to the group. Your notification settings were adjusted automatically.',
        receiptLines: [{ label: 'Application (approved)', cost: 0 }, { label: 'Norms (agreed to)', cost: 0 }, { label: 'Profile (updated)', cost: 0 }, { label: 'You (categorized)', cost: 0 }]
    },
    'themcel_rejection_end': {
        speaker: 'THEM',
        text: "We really appreciate you putting yourself out there. After some discussion, we don't think this is the right container for you right now. It's not about good or bad‚Äîit's just about fit. We'd encourage you to keep doing your work, and maybe check back in down the line. Wishing you all the best.",
        isEnding: true,
        endingTitle: 'NOT A FIT',
        endingText: 'Your application was reviewed. The decision was final. No further feedback was provided.',
        receiptLines: [{ label: 'Application (reviewed)', cost: 0 }, { label: 'Fit (insufficient)', cost: 0 }, { label: 'Door (technically open)', cost: 0 }]
    }
};

// ===== GAME STATE =====
const State = {
    appearance: { skin: 0, eyes: 0, mouth: 0, outfit: 0 },
    route: null,
    part: 1,
    nodeId: null,
    money: 100,
    patience: 10,
    receipt: [],
    runLog: [],
    reputation: {
        score: 0,
        tags: {
            leftEarly: 0,
            stayedTooLong: 0,
            boundarySetter: 0,
            humorDeflect: 0,
            engagedInSpreadsheet: 0,
            highSpend: 0,
            chaosAgent: 0
        }
    },
    part3Unlocked: false,
    integration: {
        legibility: 0,
        friction: 0,
        reframingAcceptance: 0
    }
};

// ===== SPRITE SYSTEM =====
const SPRITES = {
    incel: {
        neutral: 'sprites/wolf_neutral.png',
        angry: 'sprites/wolf_angry.png'
    },
    femcel: {
        neutral: 'sprites/cat_neutral.png',
        smirk: 'sprites/cat_smirk.png'
    },
    performative: {
        neutral: 'sprites/dog_neutral.png',
        hurt: 'sprites/dog_hurt.png'
    },
    bop: {
        neutral: 'sprites/fox_neutral.png',
        present: 'sprites/fox_present.png'
    },
    waiter: {
        neutral: 'sprites/waiter_neutral.png'
    },
    player: {
        neutral: 'sprites/player_neutral.png',
        concerned: 'sprites/player_concerned.png'
    }
};

function setSpriteImg(element, src, alt) {
    element.innerHTML = '<img src="' + src + '" alt="' + alt + '" style="width:100%;height:100%;object-fit:contain;">';
}

function setThemSprites(element) {
    element.innerHTML = '<div style="display:flex;align-items:flex-end;justify-content:center;height:100%;gap:-20px;">' +
        '<img src="' + SPRITES.incel.neutral + '" alt="wolf" style="width:40%;height:80%;object-fit:contain;margin-right:-15%;">' +
        '<img src="' + SPRITES.femcel.neutral + '" alt="cat" style="width:40%;height:85%;object-fit:contain;margin-right:-15%;">' +
        '<img src="' + SPRITES.performative.neutral + '" alt="dog" style="width:40%;height:80%;object-fit:contain;margin-right:-15%;">' +
        '<img src="' + SPRITES.bop.neutral + '" alt="fox" style="width:40%;height:85%;object-fit:contain;">' +
    '</div>';
}

// ===== SCREEN MANAGEMENT =====
function showScreen(id) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
}

// ===== CHARACTER CREATOR =====
function updatePreview() {
    const skins = ['#FFDFC4', '#F0C08A', '#CD9A6D', '#8D5524', '#4A2912'];
    const eyes = ['üëÅÔ∏è', '‚óâ', '‚ó†', '‚úø'];
    const mouths = ['‚Äø', '‚Äï', '‚ó°', 'üëÑ'];
    const outfits = ['üëî', 'üëó', 'üß•', 'üëï'];
    
    document.getElementById('layer-skin').innerHTML = '<div style="width:80px;height:100px;background:'+skins[State.appearance.skin]+';border-radius:40px 40px 20px 20px;"></div>';
    document.getElementById('layer-eyes').innerHTML = '<span style="position:absolute;top:30%;font-size:1.5rem;">'+eyes[State.appearance.eyes]+' '+eyes[State.appearance.eyes]+'</span>';
    document.getElementById('layer-mouth').innerHTML = '<span style="position:absolute;top:55%;font-size:1.5rem;">'+mouths[State.appearance.mouth]+'</span>';
    document.getElementById('layer-outfit').innerHTML = '<span style="position:absolute;top:75%;font-size:2rem;">'+outfits[State.appearance.outfit]+'</span>';
}

// ===== GAME LOGIC =====
function startGame(route, part) {
    State.route = route;
    State.part = part || 1;
    State.money = 100;
    State.patience = 10;
    State.receipt = [];
    State.runLog = [];
    updateStats();
    showScreen('screen-game');
    
    var startNode;
    var leftSprite = document.getElementById('sprite-left');
    if (State.part === 1) {
        setSpriteImg(leftSprite, SPRITES[route].neutral, route);
        startNode = route === 'incel' ? 'incel_start' : 'femcel_start';
    } else if (State.part === 2) {
        setSpriteImg(leftSprite, SPRITES[route].neutral, route);
        startNode = route === 'performative' ? 'performative_start' : 'bop_start';
    } else {
        // Part 3: The Themcel
        setThemSprites(leftSprite);
        computeIntegration(); // Compute integration values before starting
        startNode = 'themcel_start';
    }
    renderNode(startNode);
}

function renderNode(nodeId) {
    var routes;
    if (State.part === 1) {
        routes = State.route === 'incel' ? INCEL_ROUTE : FEMCEL_ROUTE;
    } else if (State.part === 2) {
        routes = State.route === 'performative' ? PERFORMATIVE_ROUTE : BOP_ROUTE;
    } else {
        routes = THEM_ROUTE;
    }
    var node = routes[nodeId];
    if (!node) return;
    
    State.nodeId = nodeId;
    
    if (node.isEnding) {
        if (node.receiptLines) State.receipt = State.receipt.concat(node.receiptLines);
        showEnding(node);
        return;
    }
    
    // Handle {RUMOR} placeholder for Part 2 start nodes
    var displayText = node.text;
    if (displayText.indexOf('{RUMOR}') >= 0) {
        displayText = displayText.replace('{RUMOR}', getRumorLine());
    }
    
    // Handle {INTEGRATION_RESULT} placeholder for Part 3
    if (displayText.indexOf('{INTEGRATION_RESULT}') >= 0) {
        displayText = displayText.replace('{INTEGRATION_RESULT}', getIntegrationResultText());
    }
    
    document.getElementById('speaker-name').textContent = node.speaker;
    document.getElementById('dialogue-text').textContent = displayText;
    
    var left = document.getElementById('sprite-left');
    var right = document.getElementById('sprite-right');
    
    // Set left sprite (date character or waiter or THEM)
    if (node.speaker === 'WAITER') {
        setSpriteImg(left, SPRITES.waiter.neutral, 'waiter');
    } else if (node.speaker === 'THEM') {
        setThemSprites(left);
    } else if (node.speaker === 'PLAYER') {
        // Player speaking - show date character faded
        if (State.part === 1) {
            setSpriteImg(left, SPRITES[State.route].neutral, State.route);
        } else if (State.part === 2) {
            setSpriteImg(left, SPRITES[State.route].neutral, State.route);
        } else {
            setThemSprites(left);
        }
    } else if (State.part === 1) {
        if (State.route === 'incel') {
            var expr = node.dateExpression === 'angry' ? 'angry' : 'neutral';
            setSpriteImg(left, SPRITES.incel[expr], 'incel');
        } else {
            var expr = node.dateExpression === 'smirk' ? 'smirk' : 'neutral';
            setSpriteImg(left, SPRITES.femcel[expr], 'femcel');
        }
    } else if (State.part === 2) {
        if (State.route === 'performative') {
            var expr = node.dateExpression === 'hurt' ? 'hurt' : 'neutral';
            setSpriteImg(left, SPRITES.performative[expr], 'performative');
        } else {
            var expr = node.dateExpression === 'present' ? 'present' : 'neutral';
            setSpriteImg(left, SPRITES.bop[expr], 'bop');
        }
    } else {
        setThemSprites(left);
    }
    
    // Set right sprite (player)
    var playerExpr = node.playerExpression === 'concerned' ? 'concerned' : 'neutral';
    setSpriteImg(right, SPRITES.player[playerExpr], 'player');
    
    left.style.opacity = node.speaker === 'PLAYER' ? '0.5' : '1';
    right.style.opacity = node.speaker === 'PLAYER' ? '1' : '0.5';
    
    var container = document.getElementById('choices-container');
    container.innerHTML = '';
    if (node.choices) {
        for (var i = 0; i < node.choices.length; i++) {
            (function(choice) {
                var btn = document.createElement('button');
                btn.className = 'choice-btn';
                btn.textContent = choice.label;
                btn.onclick = function() {
                    logChoice(nodeId, choice.label, choice.effects);
                    if (choice.effects) {
                        if (choice.effects.money) State.money += choice.effects.money;
                        if (choice.effects.patience) State.patience += choice.effects.patience;
                    }
                    if (choice.receiptLines) State.receipt = State.receipt.concat(choice.receiptLines);
                    updateStats();
                    
                    // Handle dynamic ending routing for Part 3
                    var nextId = choice.nextId;
                    if (nextId === '{INTEGRATION_ENDING}') {
                        nextId = getIntegrationEnding();
                    }
                    renderNode(nextId);
                };
                container.appendChild(btn);
            })(node.choices[i]);
        }
    }
}

function updateStats() {
    document.getElementById('stat-money').textContent = '$' + State.money;
    document.getElementById('stat-patience').textContent = State.patience;
    document.getElementById('stat-money').style.color = State.money < 20 ? '#ff3333' : '#ffd700';
    document.getElementById('stat-patience').style.color = State.patience <= 3 ? '#ff3333' : '#ffd700';
}

function showEnding(node) {
    document.getElementById('ending-title').textContent = node.endingTitle || 'DATE OVER';
    document.getElementById('ending-text').textContent = node.endingText || 'Well, that happened.';
    
    // Compute reputation only for Part 1
    if (State.part === 1) {
        computeReputationFromRunLog();
        document.getElementById('btn-next-date').classList.remove('hidden');
        document.getElementById('btn-final-phase').classList.add('hidden');
    } else if (State.part === 2) {
        // Unlock Part 3 after completing Part 2
        State.part3Unlocked = true;
        computeReputationFromRunLog(); // Also accumulate Part 2 choices
        document.getElementById('btn-next-date').classList.add('hidden');
        document.getElementById('btn-final-phase').classList.remove('hidden');
    } else {
        // Part 3 endings
        document.getElementById('btn-next-date').classList.add('hidden');
        document.getElementById('btn-final-phase').classList.add('hidden');
    }
    
    var items = document.getElementById('receipt-items');
    items.innerHTML = '';
    var total = 0;
    
    for (var i = 0; i < State.receipt.length; i++) {
        var item = State.receipt[i];
        var div = document.createElement('div');
        div.className = 'receipt-item';
        div.innerHTML = '<span class="receipt-item-label">'+item.label+'</span><span class="receipt-item-cost">'+(item.cost === 0 ? '---' : '$' + item.cost.toFixed(2))+'</span>';
        items.appendChild(div);
        total += item.cost;
    }
    
    var dmg = document.createElement('div');
    dmg.className = 'receipt-item';
    dmg.innerHTML = '<span class="receipt-item-label">Emotional Damage</span><span class="receipt-item-cost">‚àû</span>';
    items.appendChild(dmg);
    
    document.getElementById('receipt-total').textContent = '$' + total.toFixed(2);
    var balance = 100 - total;
    document.getElementById('receipt-balance').textContent = '$' + balance.toFixed(2);
    document.getElementById('receipt-balance').parentElement.className = balance >= 0 ? 'receipt-balance positive' : 'receipt-balance';
    
    if (balance < 0) document.getElementById('receipt-message').textContent = "Your card was declined.";
    else if (balance < 20) document.getElementById('receipt-message').textContent = "Hope you weren't planning to tip.";
    else document.getElementById('receipt-message').textContent = "Please don't come back.";
    
    showScreen('screen-ending');
}

// ===== REPUTATION SYSTEM =====
function logChoice(nodeId, choiceLabel, effects) {
    State.runLog.push({
        nodeId: nodeId,
        choice: choiceLabel,
        effects: effects || {},
        timestamp: Date.now()
    });
}

function computeReputationFromRunLog() {
    var log = State.runLog;
    var rep = State.reputation;
    var totalSpend = 0;
    
    for (var i = 0; i < State.receipt.length; i++) {
        totalSpend += State.receipt[i].cost;
    }
    
    // Check ending type
    var lastNode = State.nodeId;
    if (lastNode.indexOf('immediate_leave') >= 0 || lastNode.indexOf('escape') >= 0 || lastNode.indexOf('mutual_disinterest') >= 0) {
        rep.tags.leftEarly += 1;
        rep.score -= 1;
    }
    
    // Check spending
    if (totalSpend >= 40) {
        rep.tags.highSpend += 1;
        rep.score += 1;
    }
    
    // Analyze choices
    for (var j = 0; j < log.length; j++) {
        var choice = log[j].choice.toLowerCase();
        
        if (choice.indexOf('sorry') >= 0 || choice.indexOf('thank you') >= 0 || choice.indexOf('i\'ll stay') >= 0) {
            rep.tags.stayedTooLong += 1;
        }
        if (choice.indexOf('leave') >= 0 || choice.indexOf('bye') >= 0 || choice.indexOf('can\'t do this') >= 0) {
            rep.tags.boundarySetter += 1;
            rep.score += 1;
        }
        if (choice.indexOf('derek') >= 0 || choice.indexOf('millionaire') >= 0 || choice.indexOf('poor decisions') >= 0 || choice.indexOf('chaos') >= 0) {
            rep.tags.humorDeflect += 1;
            rep.tags.chaosAgent += 1;
        }
        if (choice.indexOf('spreadsheet') >= 0 || choice.indexOf('algorithm') >= 0 || choice.indexOf('show me') >= 0) {
            rep.tags.engagedInSpreadsheet += 1;
            rep.score -= 1;
        }
    }
}

function getRumorLine() {
    var tags = State.reputation.tags;
    var rumors = [];
    
    if (tags.leftEarly >= 2) rumors.push("I heard you ghost people mid-date.");
    else if (tags.leftEarly >= 1) rumors.push("I heard you leave dates early.");
    
    if (tags.boundarySetter >= 2) rumors.push("I heard you're like... intense about boundaries.");
    else if (tags.boundarySetter >= 1) rumors.push("I heard you're guarded.");
    
    if (tags.highSpend >= 2) rumors.push("I heard you throw money around.");
    else if (tags.highSpend >= 1) rumors.push("I heard you're generous.");
    
    if (tags.humorDeflect >= 2) rumors.push("I heard you never take anything seriously.");
    else if (tags.humorDeflect >= 1) rumors.push("I heard you're funny or whatever.");
    
    if (tags.chaosAgent >= 2) rumors.push("I heard you cause scenes.");
    
    if (tags.engagedInSpreadsheet >= 1) rumors.push("I heard you... entertained some weird stuff.");
    
    if (rumors.length === 0) {
        return "I heard you're new to this.";
    }
    return rumors[Math.floor(Math.random() * rumors.length)];
}

// ===== INTEGRATION SYSTEM (PART 3) =====
function computeIntegration() {
    var tags = State.reputation.tags;
    var int = State.integration;
    
    // Reset integration values
    int.legibility = 0;
    int.friction = 0;
    int.reframingAcceptance = 0;
    
    // LEGIBILITY: How easily categorized is the player?
    // Increase if consistent, explained self, used therapeutic language
    // Decrease if humor/irony, silence, unpredictable
    
    if (tags.stayedTooLong >= 2) int.legibility += 2; // Consistent engagement
    if (tags.engagedInSpreadsheet >= 1) int.legibility += 1; // Accepted frameworks
    if (tags.boundarySetter >= 1 && tags.boundarySetter <= 2) int.legibility += 1; // Predictable boundaries
    
    if (tags.humorDeflect >= 2) int.legibility -= 2; // Irony as defense
    if (tags.chaosAgent >= 2) int.legibility -= 2; // Unpredictable
    if (tags.leftEarly >= 1 && tags.stayedTooLong >= 1) int.legibility -= 1; // Inconsistent
    
    // FRICTION: How costly to process?
    // Increase if redirected, resisted consensus, challenged interpretations
    // Decrease if affirmed framing, adapted quickly
    
    if (tags.boundarySetter >= 3) int.friction += 2; // Frequent redirection
    if (tags.leftEarly >= 2) int.friction += 1; // Disruptive exits
    if (tags.chaosAgent >= 1) int.friction += 1; // Caused scenes
    
    if (tags.stayedTooLong >= 2) int.friction -= 1; // Didn't disrupt
    if (tags.engagedInSpreadsheet >= 1) int.friction -= 1; // Accepted weird stuff
    if (tags.highSpend >= 1) int.friction -= 1; // Compliant with expectations
    
    // REFRAMING ACCEPTANCE: Willingness to surrender narrative control
    // Increase if accepted interpretations, affirmed, didn't correct
    // Decrease if corrected, rejected labels, asserted own definitions
    
    if (tags.stayedTooLong >= 2) int.reframingAcceptance += 2; // Let things happen
    if (tags.engagedInSpreadsheet >= 1) int.reframingAcceptance += 1; // Accepted being categorized
    if (tags.highSpend >= 2) int.reframingAcceptance += 1; // Met expectations
    
    if (tags.boundarySetter >= 2) int.reframingAcceptance -= 1; // Resisted framing
    if (tags.humorDeflect >= 2) int.reframingAcceptance -= 1; // Deflected serious framing
    if (tags.leftEarly >= 2) int.reframingAcceptance -= 2; // Rejected the whole thing
}

function checkAcceptance() {
    var int = State.integration;
    
    // Acceptance requires:
    // - legibility >= 0 (at least neutral)
    // - friction <= 1 (low to medium)
    // - reframingAcceptance >= 1 (at least somewhat willing)
    // - At least one clearly positive axis (>= 2)
    
    var hasPositive = (int.legibility >= 2) || (int.friction <= -1) || (int.reframingAcceptance >= 2);
    var noExtreme = (int.legibility >= -2) && (int.friction <= 3) && (int.reframingAcceptance >= -2);
    
    var legibilityOk = int.legibility >= 0;
    var frictionOk = int.friction <= 1;
    var reframingOk = int.reframingAcceptance >= 1;
    
    // Need at least 2 of 3 criteria met, plus no extreme negatives, plus at least one strong positive
    var criteriaMet = (legibilityOk ? 1 : 0) + (frictionOk ? 1 : 0) + (reframingOk ? 1 : 0);
    
    return (criteriaMet >= 2) && noExtreme && hasPositive;
}

function getIntegrationResultText() {
    if (checkAcceptance()) {
        return "Okay, we've had a chance to check in with the group. Overall the feedback was positive. People felt like you'd mesh well with the vibe.";
    } else {
        return "So we've had a chance to discuss, and... we want to be honest with you. A few people flagged some concerns. Nothing major, just‚Äîsome stuff came up.";
    }
}

function getIntegrationEnding() {
    return checkAcceptance() ? 'themcel_acceptance_end' : 'themcel_rejection_end';
}

// ===== PHONE PROFILE DATA =====
const PHONE_PROFILES = {
    incel: {
        photo: 'sprites/wolf_neutral.png',
        name: 'KEVIN',
        age: '27',
        bio: '"Blackpilled truth-seeker. 6\'0 (why does that matter?). Looking for a woman who appreciates intellectual discourse and hasn\'t been corrupted by modern dating."',
        tags: ['Crypto', 'Gym (starting soon)', 'Anime', 'Philosophy', 'Anti-feminist']
    },
    femcel: {
        photo: 'sprites/cat_neutral.png',
        name: 'JESSICA',
        age: '26',
        bio: '"High value woman seeking high value man. 6 figures minimum. If you can\'t afford the lifestyle, don\'t waste my time. Venmo requests are a red flag."',
        tags: ['Luxury', 'Brunch', 'Manifestation', 'Cat mom', 'No 50/50']
    },
    performative: {
        photo: 'sprites/dog_neutral.png',
        name: 'BRENDAN',
        age: '29',
        bio: '"Emotionally evolved. Feminist ally. I cry and I\'m proud of it. Looking for someone ready to do the work. My love language is processing."',
        tags: ['Therapy', 'Breathwork', 'Men\'s group', 'Journaling', 'Vulnerability']
    },
    bop: {
        photo: 'sprites/fox_neutral.png',
        name: 'MADISON',
        age: '24',
        bio: '"Chaotic but make it fashion. 200k followers. If you can\'t handle me at my busiest you don\'t deserve me at my... also busiest. DM for collabs."',
        tags: ['Content', 'Astrology', 'Main character', 'Hot girl walks', 'Situationships']
    }
};

// ===== PHONE FUNCTIONS =====
function openPhone() {
    var profile = PHONE_PROFILES[State.route];
    if (!profile) return;
    document.getElementById('phone-photo').innerHTML = '<img src="' + profile.photo + '" alt="profile" style="width:100%;height:100%;object-fit:contain;">';
    document.getElementById('phone-name').textContent = profile.name;
    document.getElementById('phone-age').textContent = 'Age: ' + profile.age;
    document.getElementById('phone-bio').textContent = profile.bio;
    var tagsContainer = document.getElementById('phone-tags');
    tagsContainer.innerHTML = '';
    for (var i = 0; i < profile.tags.length; i++) {
        var tag = document.createElement('span');
        tag.className = 'profile-tag';
        tag.textContent = profile.tags[i];
        tagsContainer.appendChild(tag);
    }
    document.getElementById('phone-overlay').classList.remove('hidden');
}

function closePhone() {
    document.getElementById('phone-overlay').classList.add('hidden');
}

// ===== INIT =====
window.onload = function() {
    // Navigation
    document.getElementById('btn-start').onclick = function() { showScreen('screen-creator'); updatePreview(); };
    document.getElementById('btn-back-title').onclick = function() { showScreen('screen-title'); };
    document.getElementById('btn-confirm-creator').onclick = function() { showScreen('screen-dateselect'); };
    document.getElementById('btn-back-creator').onclick = function() { showScreen('screen-creator'); };
    
    // Date selection (Part 1)
    var dateButtons = document.querySelectorAll('.btn-select-date');
    for (var i = 0; i < dateButtons.length; i++) {
        (function(btn) {
            btn.onclick = function() {
                var route = btn.getAttribute('data-route');
                var part = parseInt(btn.getAttribute('data-part')) || 1;
                startGame(route, part);
            };
        })(dateButtons[i]);
    }
    
    // Character options
    var optionButtons = document.querySelectorAll('[data-option]');
    for (var j = 0; j < optionButtons.length; j++) {
        (function(btn) {
            btn.onclick = function() {
                var opt = btn.getAttribute('data-option');
                var val = parseInt(btn.getAttribute('data-value'));
                State.appearance[opt] = val;
                var siblings = btn.parentElement.querySelectorAll('button');
                for (var k = 0; k < siblings.length; k++) siblings[k].classList.remove('selected');
                btn.classList.add('selected');
                updatePreview();
            };
        })(optionButtons[j]);
    }
    
    // Menu
    document.getElementById('btn-menu').onclick = function() { document.getElementById('menu-modal').classList.remove('hidden'); };
    document.getElementById('btn-close-menu').onclick = function() { document.getElementById('menu-modal').classList.add('hidden'); };
    document.getElementById('btn-resume').onclick = function() { document.getElementById('menu-modal').classList.add('hidden'); };
    document.getElementById('btn-restart').onclick = function() { document.getElementById('menu-modal').classList.add('hidden'); startGame(State.route); };
    document.getElementById('btn-return-select').onclick = function() { document.getElementById('menu-modal').classList.add('hidden'); showScreen('screen-title'); };
    
    // Ending buttons
    document.getElementById('btn-play-again').onclick = function() { startGame(State.route, State.part); };
    document.getElementById('btn-new-date').onclick = function() { showScreen('screen-dateselect'); };
    document.getElementById('btn-new-char').onclick = function() { showScreen('screen-creator'); updatePreview(); };
    document.getElementById('btn-next-date').onclick = function() { showScreen('screen-dateselect2'); };
    document.getElementById('btn-final-phase').onclick = function() { startGame('themcel', 3); };
    
    // Part 2 back button
    document.getElementById('btn-back-ending').onclick = function() { showScreen('screen-ending'); };
    
    // Phone overlay
    document.getElementById('btn-phone').onclick = openPhone;
    document.getElementById('btn-close-phone').onclick = closePhone;
    
    console.log('Game ready!');
};
</script>
</body>
</html>
